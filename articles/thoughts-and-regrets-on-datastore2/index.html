<!DOCTYPE html><html><head><style data-href="/styles.66d281f5f2db6ee4acce.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:visible;padding:0;position:relative}pre[class*=language-]>code{background-attachment:local;background-color:#fdfdfd;background-image:linear-gradient(transparent 50%,rgba(69,142,209,.04) 0);background-origin:content-box;background-size:3em 3em;border-left:10px solid #358ccb;box-shadow:-1px 0 0 0 #358ccb,0 0 0 1px #dfdfdf;position:relative}code[class*=language-]{display:block;height:inherit;max-height:inherit;overflow:auto;padding:0 1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdfdfd;box-sizing:border-box;margin-bottom:1em}:not(pre)>code[class*=language-]{border:1px solid rgba(0,0,0,.1);border-radius:.3em;color:#c92c2c;display:inline;padding:.2em;position:relative;white-space:normal}pre[class*=language-]:after,pre[class*=language-]:before{bottom:.75em;box-shadow:0 13px 8px #979797;content:"";display:block;height:20%;left:.18em;max-height:13em;position:absolute;-webkit-transform:rotate(-2deg);transform:rotate(-2deg);width:40%;z-index:-2}pre[class*=language-]:after{left:auto;right:.75em;-webkit-transform:rotate(2deg);transform:rotate(2deg)}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#7d8b99}.token.punctuation{color:#5f6364}.token.boolean,.token.constant,.token.deleted,.token.function-name,.token.number,.token.property,.token.symbol,.token.tag{color:#c92c2c}.token.attr-name,.token.builtin,.token.char,.token.function,.token.inserted,.token.selector,.token.string{color:#2f9c0a}.token.entity,.token.operator,.token.url,.token.variable{background:hsla(0,0%,100%,.5);color:#a67f59}.token.atrule,.token.attr-value,.token.class-name,.token.keyword{color:#1990b8}.token.important,.token.regex{color:#e90}.language-css .token.string,.style .token.string{background:hsla(0,0%,100%,.5);color:#a67f59}.token.important{font-weight:400}.token.bold{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.7}@media screen and (max-width:767px){pre[class*=language-]:after,pre[class*=language-]:before{bottom:14px;box-shadow:none}}pre[class*=language-].line-numbers.line-numbers{padding-left:0}pre[class*=language-].line-numbers.line-numbers code{padding-left:3.8em}pre[class*=language-].line-numbers.line-numbers .line-numbers-rows{left:0}pre[class*=language-][data-line]{padding-bottom:0;padding-left:0;padding-top:0}pre[data-line] code{padding-left:4em;position:relative}pre .line-highlight{margin-top:0}@font-face{font-family:M PLUS\ 1p;font-style:normal;font-weight:400;src:local(""),url(/fonts/m-plus-1p-v19-latin-regular.woff2) format("woff2"),url(/fonts/m-plus-1p-v19-latin-regular.woff) format("woff")}</style><meta name="generator" content="Gatsby 3.14.6"/><title data-react-helmet="true">Thoughts and Regrets on DataStore2, and the path forward - boyned&#x27;s blog</title><meta data-react-helmet="true" charSet="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" property="og:title" content="Thoughts and Regrets on DataStore2, and the path forward - boyned&#x27;s blog"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:url" content="https://blog.boyned.com/articles/thoughts-and-regrets-on-datastore2/"/><meta data-react-helmet="true" property="og:image" content="https://blog.boyned.com/emblem.png"/><meta data-react-helmet="true" property="og:description" content="The new API changes for data stores have made me reflect a little on what the path for DataStore2 going forward is. As I say many times, my…"/><meta data-react-helmet="true" property="og:article:published_time" content="2021-02-26"/><meta data-react-helmet="true" property="og:article:author" content="boyned"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="Thoughts and Regrets on DataStore2, and the path forward - boyned&#x27;s blog"/><meta data-react-helmet="true" name="twitter:description" content="The new API changes for data stores have made me reflect a little on what the path for DataStore2 going forward is. As I say many times, my…"/><meta data-react-helmet="true" name="twitter:image" content="https://blog.boyned.com/emblem.png"/><style data-styled="" data-styled-version="5.2.1">.evPjbD{text-align:center;}/*!sc*/
data-styled.g1[id="header__StyledHeader-ehg0ch-0"]{content:"evPjbD,"}/*!sc*/
.cZwfhW{color:white;display:block;font-weight:bolder;font-size:2em;-webkit-text-decoration:none;text-decoration:none;-webkit-animation:cxWZgL 0.8s alternate infinite;animation:cxWZgL 0.8s alternate infinite;}/*!sc*/
data-styled.g2[id="header__TitleLink-ehg0ch-1"]{content:"cZwfhW,"}/*!sc*/
.dyPCyi{font-family:"M PLUS 1p";}/*!sc*/
data-styled.g3[id="layout__Main-ccgz52-0"]{content:"dyPCyi,"}/*!sc*/
body{background:repeating-linear-gradient(13deg, hsl(31,96%,85%) 0 50px, hsl(31,96%,90%) 50px 100px);background-size:100px 100px;}/*!sc*/
data-styled.g4[id="sc-global-bSvrCR1"]{content:"sc-global-bSvrCR1,"}/*!sc*/
.fCvAzx{background-color:#eee;background-image:radial-gradient(#ddd 22%,transparent 11%);background-position:0 0,50px 50px;background-size:10px 10px;margin:auto;margin-top:1em;padding:1% 3%;max-width:850px;width:calc(100% - 20px);}/*!sc*/
.fCvAzx blockquote{background:white;padding:8px;margin:8px;border-left:4px solid #77f;}/*!sc*/
.fCvAzx p{margin:0;}/*!sc*/
data-styled.g5[id="layout__Content-ccgz52-1"]{content:"fCvAzx,"}/*!sc*/
.fhnqlE .custom-block.info{background:hsla(217,90%,60%,50%);border:5px solid hsla(217,90%,60%,50%);border-radius:10px;padding:0.5% 1.5%;}/*!sc*/
.fhnqlE .custom-block.info .custom-block-heading{font-weight:bold;font-size:1.5em;text-align:center;}/*!sc*/
data-styled.g9[id="article__BlogContent-sc-1uy6qa4-0"]{content:"fhnqlE,"}/*!sc*/
@-webkit-keyframes cxWZgL{0%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}25%{text-shadow:0 -0.05em 0.2em #FFF,0 -0.05em 0.17em #FE0,0.04em -0.12em 0.22em #FC0,0.04em -0.13em 0.27em #F90,0.05em -0.23em 0.33em #F70,0.07em -0.28em 0.47em #F70,0.1em -0.3em 0.8em #F50,0.1em -0.3em 0.9em #F40;}50%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}75%{text-shadow:0 -0.05em 0.2em #FFF,0 -0.06em 0.18em #FE0,0.05em -0.15em 0.23em #FC0,0.05em -0.15em 0.3em #F90,0.07em -0.25em 0.4em #F70,0.09em -0.3em 0.5em #F70,0.1em -0.3em 0.9em #F50,0.1em -0.3em 1.0em #F40;}100%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}}/*!sc*/
@keyframes cxWZgL{0%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}25%{text-shadow:0 -0.05em 0.2em #FFF,0 -0.05em 0.17em #FE0,0.04em -0.12em 0.22em #FC0,0.04em -0.13em 0.27em #F90,0.05em -0.23em 0.33em #F70,0.07em -0.28em 0.47em #F70,0.1em -0.3em 0.8em #F50,0.1em -0.3em 0.9em #F40;}50%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}75%{text-shadow:0 -0.05em 0.2em #FFF,0 -0.06em 0.18em #FE0,0.05em -0.15em 0.23em #FC0,0.05em -0.15em 0.3em #F90,0.07em -0.25em 0.4em #F70,0.09em -0.3em 0.5em #F70,0.1em -0.3em 0.9em #F50,0.1em -0.3em 1.0em #F40;}100%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}}/*!sc*/
data-styled.g10[id="sc-keyframes-cxWZgL"]{content:"cxWZgL,"}/*!sc*/
.hDXFNt{color:white;-webkit-filter:drop-shadow(3px 3px 3px black);filter:drop-shadow(3px 3px 3px black);}/*!sc*/
data-styled.g11[id="header__StyledLinks-ehg0ch-2"]{content:"hDXFNt,"}/*!sc*/
.eNBbfj{color:white;-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g12[id="header__StyledLink-ehg0ch-3"]{content:"eNBbfj,"}/*!sc*/
</style><link as="script" rel="preload" href="/webpack-runtime-dfc7841f6f79d0d83b6e.js"/><link as="script" rel="preload" href="/framework-37869815b964c2e4180c.js"/><link as="script" rel="preload" href="/app-a6864048c0301abf14c6.js"/><link as="script" rel="preload" href="/commons-7eb882d59dd8e849a053.js"/><link as="script" rel="preload" href="/component---src-templates-article-tsx-446c53b14a781b62ca98.js"/><link as="fetch" rel="preload" href="/page-data/articles/thoughts-and-regrets-on-datastore2/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2428300253.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout__Main-ccgz52-0 dyPCyi"><div class="header__StyledHeader-ehg0ch-0 evPjbD"><a class="header__TitleLink-ehg0ch-1 cZwfhW" href="/">boyned&#x27;s blog</a><div class="header__StyledLinks-ehg0ch-2 hDXFNt"><span><a href="https://twitter.com/Kampfkarren" class="header__StyledLink-ehg0ch-3 eNBbfj">Twitter</a> <!-- --> | </span><span><a href="https://github.com/Kampfkarren" class="header__StyledLink-ehg0ch-3 eNBbfj">GitHub</a> <!-- --> | </span><span><a href="https://ko-fi.com/boyned" class="header__StyledLink-ehg0ch-3 eNBbfj">Ko-fi</a> </span></div></div><div class="layout__Content-ccgz52-1 fCvAzx"><header style="border-bottom:2px solid rgba(50, 50, 50, 0.3)"><h1 style="margin-bottom:-4px">Thoughts and Regrets on DataStore2, and the path forward</h1><p>7<!-- --> minute read</p></header><div class="article__BlogContent-sc-1uy6qa4-0 fhnqlE"><span><p>The new API changes for data stores have made me reflect a little on what the path for DataStore2 going forward is. As I say many times, my projects move with me. They are open source, yes, and open to contribution, but I don't support projects I don't use, and I don't add features I don't use. This is why, for example, there is no getting data stores by user ID in DataStore2. There are some safety cautions (mostly with users being in a separate server as you use it), but the primary reason is that I have never had a reason to want it, and nobody has sent a pull request.</p>
<p>That being said, I've moved a long way since DataStore2. DataStore2 is a module written 3 years ago for Battle Hats that I released just on a whim, and it blew up far past what I could have ever expected. I'm of course very happy that my work is being used in lots of huge games, and whenever the topic of data store libraries come out, they always have to compare to me. It's also nice to see Roblox seeing DataStore2 as a point of reference for future APIs. That being said, it is very challenging for me to maintain.</p>
<h2>The Good</h2>
<ul>
<li>DataStore2 is absurdly easy to use, and nothing else I've seen even comes close. The ease of use of :Get(), write, then :Set() is unmatched. I know this because of some of the kinds of questions I get, which suggest to me that my module is good even for beginners.</li>
<li>DataStore2 is battle tested. The bugs that are known in it are very minor, as everything has been ironed out in games with combined billions of visits.</li>
</ul>
<h2>The Bad</h2>
<ul>
<li>Every single :Get() in DataStore2 performs a deep copy. This is because when I first wrote the module, I had no idea about immutable operations, and how easy they are to do. Modifying this behavior is a breaking change, as it forms the <em>entire backbone</em> of DataStore2's simple API.</li>
<li>Combine was an afterthought. This is because I had no idea how limited ODS throttles were, and didn't think about how some data would come in and some wouldn't. It should be a native part of the API. This is a breaking change.</li>
<li><code class="language-text">DataStore2(dataStoreName)</code> is ugly, and forced DataStore2 to adopt a weird <code class="language-text">__call</code> metatable structure. I would have gone with <code class="language-text">DataStore2.new</code> nowadays.</li>
<li>Operations block instead of making promises. This is because I'm not even sure Lua Promises existed at the time of initial writing, but also, if they did, I would not have known about them anyway. This has been sort of resolved with <code class="language-text">:GetAsync()</code> and friends, but it's far from perfect.</li>
<li>DataStore2's identity has, without my will, revolved around the ordered backups saving mechanic, something I no longer recommend (especially after the recent-ish data crash) and that I am not convinced actually helps DataStore2 not lose data. I am more convinced that DataStore2 doesn't lose data because it's battle tested. I always wanted DataStore2's identity to resolve around its cache and easy API.</li>
<li>DataStore2 has no migration support. This is because I didn't know what they were when I was making it. <a href="https://github.com/Kampfkarren/zombie-strike/blob/master/src/shared/ServerScriptService/Data.lua">Zombie Strike had something tacked on that essentially just wrapped all of DataStore2 in another API.</a></li>
<li>DataStore2 is one singleton. This is great for simplicity, but bad for testing.</li>
<li>DataStore2 barfs its logging with no way to configure it.</li>
</ul>
<p>You'll notice a lot of these have "I didn't know" attached to it. That's where DataStore2 collapses--it was made by a 15 year old who was convinced XML style documentation was the future, and whose only prior experience with data storage at a higher scale than saving a text file was old PHP websites with MySQL injection. I've come a long way since then.</p>
<h2>The Future</h2>
<p>My projects still move with me, and I do not plan on touching anything data store related until my next project needs it (which won't be for a while, we've been explicitly trying to create a V-slice with the restriction of "nothing that will need to save data"). I have a lot of time to think on it, but I am <strong>considering not updating DataStore2 with anything other than contributions, and starting a new project</strong>. I will likely not advertise this new project on the Developer Forums, as I do not feel capable of single-handedly running a project of such an important backbone for thousands of people, especially with no income (if you'd contribute to a Patreon or Kofi, let me know :wink:). I might just keep it to a repository, and perhaps a thread on the Fivum, or the Community Dev Forums, or whatever I'm supposed to call it.</p>
<h2>Goals</h2>
<ul>
<li>Be 100% Promise based.</li>
<li>Combine by default.</li>
<li>Cache, just like DataStore2.</li>
<li>Use standard data stores. Supporting other saving methods is fine.</li>
<li>Try to be as simple as possible, but with these restrictions it is likely impossible to get anywhere close to DataStore2's simplicity.</li>
<li>Support migration.</li>
<li>Support data store validators. <a href="https://twitter.com/Kampfkarren/status/1202397746096771072">Would hopefully stop this.</a> On that note, make deletion explicit, rather than just <code class="language-text">:Set(nil)</code>.</li>
<li>Make BeforeInitialGet/BeforeSave only possible to define once. I don't mean erroring if they're ran a second time, I mean <strong>make it impossible</strong>.</li>
<li>Backups, but in the <code class="language-text">:SetBackup</code> sense.</li>
<li>Support the new DataStore APIs as sanely as possible.</li>
<li>Expect the user to perform updates immutably. This means that if the user mutates <code class="language-text">:Get()</code> directly, then the code will explode and it is their fault (though we can provide a configuration option to error when they do this). This can also be supported by having helper methods like <code class="language-text">assign</code>.</li>
<li>Never upload it as a free model. Requiring by ID is evil, and not only is it impossible for me to update the DataStore2 free model (it has been bugged for ages), but as anyone who uses Hoarcekat knows, I'm also just awful about updating that sort of thing.</li>
<li>Maybe avoid singletons with things like thunks. I'm not actually sure yet.</li>
<li>Don't aim for backwards compatibility with DataStore2, or anything else. I am not maintaining my old games, so I am designing with the freedom of knowing past games will be empty.</li>
<li>Still be player specific. Sorry, it's just easy to use and I have no reason to want to care about server data stores or data stores of players outside of the game. Plus, this means with the new data store APIs, I'll be able to easily introduce GDPR support.</li>
<li>Configurable logging.</li>
</ul>
<p>If this sounds a lot like <a href="https://github.com/evaera/quicksave">Quicksave</a>, that's because it is. I don't know why I want to reinvent the wheel, maybe I just like watching things roll.</p>
<h2>Example Code</h2>
<p>This is just off my dome, there is no actual code to make this work yet. The data store library is referred to as Bikeshed, here.</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token comment">-- Old code</span>
DataStore2<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span><span class="token string">"DATA"</span><span class="token punctuation">,</span> <span class="token string">"Inventory"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> inventoryStore <span class="token operator">=</span> <span class="token function">DataStore2</span><span class="token punctuation">(</span>player<span class="token punctuation">,</span> <span class="token string">"Inventory"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> inventory <span class="token operator">=</span> inventoryStore<span class="token punctuation">:</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>inventory<span class="token punctuation">,</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> <span class="token string">"Doge"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
inventoryStore<span class="token punctuation">:</span><span class="token function">Set</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span>

<span class="token comment">-- or...</span>
inventoryStore<span class="token punctuation">:</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span>
    table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>inventory<span class="token punctuation">,</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> <span class="token string">"Doge"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> inventory
<span class="token keyword">end</span><span class="token punctuation">)</span></code></pre></div>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token comment">-- New code</span>

<span class="token comment">-- Ideally you will limit your use of withBikeshed, and pass down the</span>
<span class="token comment">-- API through dependency injection (as parameters of a function).</span>
<span class="token function">withBikeshed</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>bikeshed<span class="token punctuation">)</span>
    <span class="token keyword">local</span> dataStore <span class="token operator">=</span> bikeshed<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span>
    <span class="token keyword">local</span> inventoryStore <span class="token operator">=</span> dataStore<span class="token punctuation">:</span><span class="token function">getStore</span><span class="token punctuation">(</span>stores<span class="token punctuation">.</span>Inventory<span class="token punctuation">)</span>

    inventoryStore<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">andThen</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span>
        <span class="token comment">-- You would likely have helpers for this,</span>
        <span class="token comment">-- maybe in something like Llama.</span>
        <span class="token keyword">local</span> inventoryCopy <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> _<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span> <span class="token keyword">do</span>
            table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>inventoryCopy<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
        <span class="token keyword">end</span>

        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>inventoryCopy<span class="token punctuation">,</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> <span class="token string">"Doge"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">-- This likely doesn't need to be a promise.</span>
        inventoryStore<span class="token punctuation">:</span><span class="token function">set</span><span class="token punctuation">(</span>inventoryCopy<span class="token punctuation">)</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>

    <span class="token comment">-- or...</span>
    inventoryStore<span class="token punctuation">:</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span>
        inventory <span class="token operator">=</span> <span class="token function">copy</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span> <span class="token comment">-- `copy` is implemented elsewhere, by you.</span>
        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>inventory<span class="token punctuation">,</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> <span class="token string">"Doge"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> inventory
    <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span></code></pre></div>
<h3>Data store structures</h3>
<p>This is where <code class="language-text">stores.Inventory</code> comes from. It's a struct like this:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token keyword">local</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>ReplicatedStorage<span class="token punctuation">.</span>Vendor<span class="token punctuation">.</span>t<span class="token punctuation">)</span>

<span class="token keyword">local</span> InventoryStore <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

InventoryStore<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">"Inventory"</span>

<span class="token comment">-- No more :Get({}).</span>
InventoryStore<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">-- `validate` is just a function that receives the data and returns</span>
<span class="token comment">-- `true` if the data is valid and `false, error` if it is not.</span>
<span class="token comment">-- This is beautifully generic, and allows for `t` to be used, so I do</span>
<span class="token comment">-- not have to write more boilerplate myself.</span>
InventoryStore<span class="token punctuation">.</span>validate <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>Items<span class="token punctuation">.</span>validateItem<span class="token punctuation">)</span>

<span class="token comment">-- These are optional</span>
InventoryStore<span class="token punctuation">.</span>validateSerialized <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>
    t<span class="token punctuation">.</span><span class="token function">numberConstrained</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>Items<span class="token punctuation">.</span>items<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">-- Both this and `deserialize` can possibly return promises, that's fine.</span>
<span class="token keyword">function</span> InventoryStore<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">local</span> serialized <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">for</span> _<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">do</span>
        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>serialized<span class="token punctuation">,</span> Items<span class="token punctuation">.</span><span class="token function">getIdByName</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token keyword">return</span> serialized
<span class="token keyword">end</span>

<span class="token keyword">function</span> InventoryStore<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">local</span> deserialized <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">for</span> _<span class="token punctuation">,</span> itemId <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">do</span>
        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>deserialized<span class="token punctuation">,</span> Items<span class="token punctuation">.</span><span class="token function">getItemById</span><span class="token punctuation">(</span>itemId<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token keyword">return</span> deserialized
<span class="token keyword">end</span>

<span class="token keyword">return</span> InventoryStore</code></pre></div>
<h3>Accepting Combine by default, and global config</h3>
<p>Things like <code class="language-text">:SetBackup</code> and <code class="language-text">:Save</code> were not invented with things like Combine in mind (that's why <code class="language-text">DataStore2.SaveAll</code> exists). Now that Combine is default, this new API could instead just have a global configuration.</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua">Bikeshed<span class="token punctuation">.</span><span class="token function">setGlobalConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    backupsEnabled <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment">-- Might even be on by default, not sure.</span>
    retryTimes <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>

    loggingLevel <span class="token operator">=</span> Bikeshed<span class="token punctuation">.</span>LoggingLevel<span class="token punctuation">.</span>Trace<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">--- ...or even</span>

<span class="token keyword">local</span> withBikeshed <span class="token operator">=</span> Bikeshed<span class="token punctuation">.</span><span class="token function">useConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">-- ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token function">withBikeshed</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>bikeshed<span class="token punctuation">)</span>
    <span class="token keyword">local</span> dataStore <span class="token operator">=</span> bikeshed<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span>

    dataStore<span class="token punctuation">:</span><span class="token function">getStore</span><span class="token punctuation">(</span>stores<span class="token punctuation">.</span>Inventory<span class="token punctuation">)</span>
        <span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span><span class="token function">andThen</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span>
            <span class="token comment">-- Player buys an item</span>
            dataStore<span class="token punctuation">:</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span></code></pre></div>
<h3>Migrations</h3>
<p>I still am not solid on a good API for this, but this is what I can come up with, and is similar to what I did in Zombie Strike:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token comment">-- Looks like saving names was a stupid idea...</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">namesToIds</span><span class="token punctuation">(</span>dataStore<span class="token punctuation">)</span>
    <span class="token keyword">return</span> dataStore<span class="token punctuation">:</span><span class="token function">getStore</span><span class="token punctuation">(</span>stores<span class="token punctuation">.</span>Inventory<span class="token punctuation">)</span>
        <span class="token punctuation">:</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span>
            <span class="token keyword">local</span> newInventory <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token keyword">for</span> _<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span> <span class="token keyword">do</span>
                table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>newInventory<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    Id <span class="token operator">=</span> Items<span class="token punctuation">.</span><span class="token function">getIdByName</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">end</span>

            <span class="token keyword">return</span> newInventory
        <span class="token keyword">end</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Yep, all done! Migrations return promises."</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

Bikeshed<span class="token punctuation">.</span><span class="token function">setMigrations</span><span class="token punctuation">(</span><span class="token punctuation">{</span> namesToIds <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<h2>The Elephant in the Room</h2>
<p>If I call it DataStore3, shoot me.</p></span></div><hr/><a href="/">Back to blog</a><div><noscript>You need JavaScript to be able to comment.</noscript></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/articles/thoughts-and-regrets-on-datastore2/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-c64b171993bb26b718fb.js"],"app":["/app-a6864048c0301abf14c6.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-1c3725810481f8d99e37.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-bfd3d98725a8c29a9009.js"],"component---src-templates-article-tsx":["/component---src-templates-article-tsx-446c53b14a781b62ca98.js"]};/*]]>*/</script><script src="/polyfill-c64b171993bb26b718fb.js" nomodule=""></script><script src="/component---src-templates-article-tsx-446c53b14a781b62ca98.js" async=""></script><script src="/commons-7eb882d59dd8e849a053.js" async=""></script><script src="/app-a6864048c0301abf14c6.js" async=""></script><script src="/framework-37869815b964c2e4180c.js" async=""></script><script src="/webpack-runtime-dfc7841f6f79d0d83b6e.js" async=""></script></body></html>