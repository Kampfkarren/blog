<!DOCTYPE html><html><head><style data-href="/styles.66d281f5f2db6ee4acce.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:visible;padding:0;position:relative}pre[class*=language-]>code{background-attachment:local;background-color:#fdfdfd;background-image:linear-gradient(transparent 50%,rgba(69,142,209,.04) 0);background-origin:content-box;background-size:3em 3em;border-left:10px solid #358ccb;box-shadow:-1px 0 0 0 #358ccb,0 0 0 1px #dfdfdf;position:relative}code[class*=language-]{display:block;height:inherit;max-height:inherit;overflow:auto;padding:0 1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdfdfd;box-sizing:border-box;margin-bottom:1em}:not(pre)>code[class*=language-]{border:1px solid rgba(0,0,0,.1);border-radius:.3em;color:#c92c2c;display:inline;padding:.2em;position:relative;white-space:normal}pre[class*=language-]:after,pre[class*=language-]:before{bottom:.75em;box-shadow:0 13px 8px #979797;content:"";display:block;height:20%;left:.18em;max-height:13em;position:absolute;-webkit-transform:rotate(-2deg);transform:rotate(-2deg);width:40%;z-index:-2}pre[class*=language-]:after{left:auto;right:.75em;-webkit-transform:rotate(2deg);transform:rotate(2deg)}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#7d8b99}.token.punctuation{color:#5f6364}.token.boolean,.token.constant,.token.deleted,.token.function-name,.token.number,.token.property,.token.symbol,.token.tag{color:#c92c2c}.token.attr-name,.token.builtin,.token.char,.token.function,.token.inserted,.token.selector,.token.string{color:#2f9c0a}.token.entity,.token.operator,.token.url,.token.variable{background:hsla(0,0%,100%,.5);color:#a67f59}.token.atrule,.token.attr-value,.token.class-name,.token.keyword{color:#1990b8}.token.important,.token.regex{color:#e90}.language-css .token.string,.style .token.string{background:hsla(0,0%,100%,.5);color:#a67f59}.token.important{font-weight:400}.token.bold{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.7}@media screen and (max-width:767px){pre[class*=language-]:after,pre[class*=language-]:before{bottom:14px;box-shadow:none}}pre[class*=language-].line-numbers.line-numbers{padding-left:0}pre[class*=language-].line-numbers.line-numbers code{padding-left:3.8em}pre[class*=language-].line-numbers.line-numbers .line-numbers-rows{left:0}pre[class*=language-][data-line]{padding-bottom:0;padding-left:0;padding-top:0}pre[data-line] code{padding-left:4em;position:relative}pre .line-highlight{margin-top:0}@font-face{font-family:M PLUS\ 1p;font-style:normal;font-weight:400;src:local(""),url(/fonts/m-plus-1p-v19-latin-regular.woff2) format("woff2"),url(/fonts/m-plus-1p-v19-latin-regular.woff) format("woff")}</style><meta name="generator" content="Gatsby 3.14.6"/><title data-react-helmet="true">Migrations, validators, and strict typing - boyned&#x27;s blog</title><meta data-react-helmet="true" charSet="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" property="og:title" content="Migrations, validators, and strict typing - boyned&#x27;s blog"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:url" content="https://blog.boyned.com/articles/migrators-validators-and-strict-typing/"/><meta data-react-helmet="true" property="og:image" content="https://blog.boyned.com/emblem.png"/><meta data-react-helmet="true" property="og:description" content="In Thoughts and Regrets on DataStore2, and the path forward, there are two features that have been pointed out to me as being contradictory…"/><meta data-react-helmet="true" property="og:article:published_time" content="2021-03-03"/><meta data-react-helmet="true" property="og:article:author" content="boyned"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="Migrations, validators, and strict typing - boyned&#x27;s blog"/><meta data-react-helmet="true" name="twitter:description" content="In Thoughts and Regrets on DataStore2, and the path forward, there are two features that have been pointed out to me as being contradictory…"/><meta data-react-helmet="true" name="twitter:image" content="https://blog.boyned.com/emblem.png"/><style data-styled="" data-styled-version="5.2.1">.evPjbD{text-align:center;}/*!sc*/
data-styled.g1[id="header__StyledHeader-ehg0ch-0"]{content:"evPjbD,"}/*!sc*/
.cZwfhW{color:white;display:block;font-weight:bolder;font-size:2em;-webkit-text-decoration:none;text-decoration:none;-webkit-animation:cxWZgL 0.8s alternate infinite;animation:cxWZgL 0.8s alternate infinite;}/*!sc*/
data-styled.g2[id="header__TitleLink-ehg0ch-1"]{content:"cZwfhW,"}/*!sc*/
.dyPCyi{font-family:"M PLUS 1p";}/*!sc*/
data-styled.g3[id="layout__Main-ccgz52-0"]{content:"dyPCyi,"}/*!sc*/
body{background:repeating-linear-gradient(13deg, hsl(31,96%,85%) 0 50px, hsl(31,96%,90%) 50px 100px);background-size:100px 100px;}/*!sc*/
data-styled.g4[id="sc-global-bSvrCR1"]{content:"sc-global-bSvrCR1,"}/*!sc*/
.fCvAzx{background-color:#eee;background-image:radial-gradient(#ddd 22%,transparent 11%);background-position:0 0,50px 50px;background-size:10px 10px;margin:auto;margin-top:1em;padding:1% 3%;max-width:850px;width:calc(100% - 20px);}/*!sc*/
.fCvAzx blockquote{background:white;padding:8px;margin:8px;border-left:4px solid #77f;}/*!sc*/
.fCvAzx p{margin:0;}/*!sc*/
data-styled.g5[id="layout__Content-ccgz52-1"]{content:"fCvAzx,"}/*!sc*/
.fhnqlE .custom-block.info{background:hsla(217,90%,60%,50%);border:5px solid hsla(217,90%,60%,50%);border-radius:10px;padding:0.5% 1.5%;}/*!sc*/
.fhnqlE .custom-block.info .custom-block-heading{font-weight:bold;font-size:1.5em;text-align:center;}/*!sc*/
data-styled.g9[id="article__BlogContent-sc-1uy6qa4-0"]{content:"fhnqlE,"}/*!sc*/
@-webkit-keyframes cxWZgL{0%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}25%{text-shadow:0 -0.05em 0.2em #FFF,0 -0.05em 0.17em #FE0,0.04em -0.12em 0.22em #FC0,0.04em -0.13em 0.27em #F90,0.05em -0.23em 0.33em #F70,0.07em -0.28em 0.47em #F70,0.1em -0.3em 0.8em #F50,0.1em -0.3em 0.9em #F40;}50%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}75%{text-shadow:0 -0.05em 0.2em #FFF,0 -0.06em 0.18em #FE0,0.05em -0.15em 0.23em #FC0,0.05em -0.15em 0.3em #F90,0.07em -0.25em 0.4em #F70,0.09em -0.3em 0.5em #F70,0.1em -0.3em 0.9em #F50,0.1em -0.3em 1.0em #F40;}100%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}}/*!sc*/
@keyframes cxWZgL{0%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}25%{text-shadow:0 -0.05em 0.2em #FFF,0 -0.05em 0.17em #FE0,0.04em -0.12em 0.22em #FC0,0.04em -0.13em 0.27em #F90,0.05em -0.23em 0.33em #F70,0.07em -0.28em 0.47em #F70,0.1em -0.3em 0.8em #F50,0.1em -0.3em 0.9em #F40;}50%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}75%{text-shadow:0 -0.05em 0.2em #FFF,0 -0.06em 0.18em #FE0,0.05em -0.15em 0.23em #FC0,0.05em -0.15em 0.3em #F90,0.07em -0.25em 0.4em #F70,0.09em -0.3em 0.5em #F70,0.1em -0.3em 0.9em #F50,0.1em -0.3em 1.0em #F40;}100%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}}/*!sc*/
data-styled.g10[id="sc-keyframes-cxWZgL"]{content:"cxWZgL,"}/*!sc*/
.hDXFNt{color:white;-webkit-filter:drop-shadow(3px 3px 3px black);filter:drop-shadow(3px 3px 3px black);}/*!sc*/
data-styled.g11[id="header__StyledLinks-ehg0ch-2"]{content:"hDXFNt,"}/*!sc*/
.eNBbfj{color:white;-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g12[id="header__StyledLink-ehg0ch-3"]{content:"eNBbfj,"}/*!sc*/
</style><link as="script" rel="preload" href="/webpack-runtime-dfc7841f6f79d0d83b6e.js"/><link as="script" rel="preload" href="/framework-37869815b964c2e4180c.js"/><link as="script" rel="preload" href="/app-a6864048c0301abf14c6.js"/><link as="script" rel="preload" href="/commons-7eb882d59dd8e849a053.js"/><link as="script" rel="preload" href="/component---src-templates-article-tsx-446c53b14a781b62ca98.js"/><link as="fetch" rel="preload" href="/page-data/articles/migrators-validators-and-strict-typing/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2428300253.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout__Main-ccgz52-0 dyPCyi"><div class="header__StyledHeader-ehg0ch-0 evPjbD"><a class="header__TitleLink-ehg0ch-1 cZwfhW" href="/">boyned&#x27;s blog</a><div class="header__StyledLinks-ehg0ch-2 hDXFNt"><span><a href="https://twitter.com/Kampfkarren" class="header__StyledLink-ehg0ch-3 eNBbfj">Twitter</a> <!-- --> | </span><span><a href="https://github.com/Kampfkarren" class="header__StyledLink-ehg0ch-3 eNBbfj">GitHub</a> <!-- --> | </span><span><a href="https://ko-fi.com/boyned" class="header__StyledLink-ehg0ch-3 eNBbfj">Ko-fi</a> </span></div></div><div class="layout__Content-ccgz52-1 fCvAzx"><header style="border-bottom:2px solid rgba(50, 50, 50, 0.3)"><h1 style="margin-bottom:-4px">Migrations, validators, and strict typing</h1><p>9<!-- --> minute read</p></header><div class="article__BlogContent-sc-1uy6qa4-0 fhnqlE"><span><p>In <a href="/articles/thoughts-and-regrets-on-datastore2/">Thoughts and Regrets on DataStore2, and the path forward</a>, there are two features that have been pointed out to me as being contradictory.</p>
<ul>
<li>Validators (which validate a data store's value during <code class="language-text">:set()</code>)</li>
<li>Automatic migrations</li>
</ul>
<p>Validators are simply a function of the type <code class="language-text">(possibleValue: T) =&gt; (true) | (false, error: string)</code>. The code example I gave for migrations was:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token comment">-- Looks like saving names was a stupid idea...</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">namesToIds</span><span class="token punctuation">(</span>dataStore<span class="token punctuation">)</span>
    <span class="token keyword">return</span> dataStore<span class="token punctuation">:</span><span class="token function">getStore</span><span class="token punctuation">(</span>stores<span class="token punctuation">.</span>Inventory<span class="token punctuation">)</span>
        <span class="token punctuation">:</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span>
            <span class="token keyword">local</span> newInventory <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token keyword">for</span> _<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span> <span class="token keyword">do</span>
                table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>newInventory<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    Id <span class="token operator">=</span> Items<span class="token punctuation">.</span><span class="token function">getIdByName</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">end</span>

            <span class="token keyword">return</span> newInventory
        <span class="token keyword">end</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Yep, all done! Migrations return promises."</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

Bikeshed<span class="token punctuation">.</span><span class="token function">setMigrations</span><span class="token punctuation">(</span><span class="token punctuation">{</span> namesToIds <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>There's a few issues with this though. I'll go over them individually.</p>
<p>This migration file would work for the case of having an old inventory with names and turning it into a new inventory with IDs. The validator when the <code class="language-text">:update</code> is finished would correctly check that the data is valid, since it is assumed it will be updated to check for an <code class="language-text">Id</code> field rather than a <code class="language-text">Name</code> field.</p>
<p>However, let's suppose we realize we don't want an entire table for every item, and just want inventories to be a store of numbers. We'd write a migration like this...</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">namesToIds</span><span class="token punctuation">(</span>dataStore<span class="token punctuation">)</span>
    <span class="token comment">-- snip</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">idsToNumbers</span><span class="token punctuation">(</span>dataStore<span class="token punctuation">)</span>
    <span class="token keyword">return</span> dataStore<span class="token punctuation">:</span><span class="token function">getStore</span><span class="token punctuation">(</span>stores<span class="token punctuation">.</span>Inventory<span class="token punctuation">)</span>
        <span class="token punctuation">:</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span>
            <span class="token keyword">local</span> newInventory <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token keyword">for</span> _<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span> <span class="token keyword">do</span>
                table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>newInventory<span class="token punctuation">,</span> item<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
            <span class="token keyword">end</span>

            <span class="token keyword">return</span> newInventory
        <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

Bikeshed<span class="token punctuation">.</span><span class="token function">setMigrations</span><span class="token punctuation">(</span><span class="token punctuation">{</span> namesToIds<span class="token punctuation">,</span> idsToNumbers <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>...and our validator would become:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua">Inventory<span class="token punctuation">.</span>validate <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>number<span class="token punctuation">)</span></code></pre></div>
<p>The flow of a player on the version where items are <code class="language-text">{ Id: number }</code> would go through the following pipeline:</p>
<ul>
<li>Player connects</li>
<li>Data store library detects they are on a version with <code class="language-text">{ Id: number }[]</code>, runs the <code class="language-text">idsToNumbers</code> migration.</li>
<li>After the <code class="language-text">:update</code> is finished, validator is ran.</li>
<li>Data is an array of numbers, pass.</li>
</ul>
<p>This is all good. However, what happens when a player on the <em>original</em> data connects? One with <code class="language-text">{ Name: string }[]</code>?</p>
<ul>
<li>Player connects</li>
<li>Data store library detects they are on a version with <code class="language-text">{ Name: string }[]</code>, runs the <code class="language-text">namesToIds</code> migration.</li>
<li>After the <code class="language-text">:update</code> is finished, validator is run.</li>
<li><strong>Data is an array of <code class="language-text">{ Id: number }</code>, <em>not</em> an array of numbers. Fail.</strong></li>
</ul>
<p>Uh oh.</p>
<p>The way we wrote our individual migrations is ideal, migrations simply apply one after the other until the version is up to date. Anything else would become frustrating to maintain. However, the problem comes with the validators being changed. We need to come up with a better solution.</p>
<h3>Turn off validators until the last migration?</h3>
<p>This is the most obvious solution, but I don't think it's ideal. The validators exist to protect you from yourself. I don't want situations where it's possible to corrupt your data from a bad migration. This is especially dangerous given the fact migrations are chained, and so you'll be passing in bad data from one migration to the next silently, with it only erroring in some unrelated migration.</p>
<h3>Make migrations more generic?</h3>
<p>This is the more ideal plan of action. Right now, migrations are <code class="language-text">(dataStore: BikeshedDataStore) -&gt; Promise&lt;void&gt;</code>. This is already pretty generic, but has the issues you see in the example above. Furthermore, it's a bit tricky to test compared to something that's simply data in, data out.</p>
<p>Let's think for a moment, what do we use migrations for?</p>
<ul>
<li>Mutating existing data stores (changing <code class="language-text">{ Name: string }</code> to <code class="language-text">{ Id: number }</code> to <code class="language-text">number</code>)</li>
<li>Deleting old, unnecessary data stores.</li>
<li>Replacing old, unnecessary data stores (maybe replacing an "Items" data store to a more broader "Inventory" data store).</li>
<li>(If you have another use case these do not cover, let me know!)</li>
</ul>
<p><em>Creating</em> new data stores is likely not under the scope of a migration (outside of replacing)--new data stores will be created when a new player joins without existing data there anyway.</p>
<p>The first example can be abstracted to a simple <code class="language-text">migration(data: T) =&gt; Promise&lt;U&gt;</code>. A function for mutating existing data stores could just be:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">idsToNumbers</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span>
    <span class="token keyword">local</span> newInventory <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">for</span> _<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span> <span class="token keyword">do</span>
        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>newInventory<span class="token punctuation">,</span> item<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>newInventory<span class="token punctuation">)</span>
<span class="token keyword">end</span></code></pre></div>
<p>The second one <em>could</em> be, but I believe deletion should be explicit anyway, so simply <code class="language-text">migration(data: T) =&gt; Promise&lt;nil&gt;</code> being the same as deletion is a bit worrying to me. Although, this is what validators are meant to resolve anyway, so knowing that all data stores should have validators, I'm a bit more open to it (why would you allow a nil through validation other than to delete? Would someone returning nil expect it to delete, or would they expect it to somehow just preserve the nil and not try to retrieve default values later?).</p>
<p>The third one is tricky. It involves creating new data stores, so to preserve the data in, data out behavior, <code class="language-text">migration</code> would have to:</p>
<ul>
<li>Mutate within itself (:grimacing:)</li>
<li>Create new data stores, <strong>still with the old validators</strong>.</li>
</ul>
<h2>The Solution</h2>
<p>I should preface this with the fact that <strong>I have no idea if this solution is actually any good.</strong> This library won't be written until far in the future when I need it, so I'll hopefully figure out the kinks either then or before then.</p>
<p>Basically, I think migrations should not just return data, and not just be blind functions, but <strong>should return actions.</strong></p>
<p>These actions would be (names not final):</p>
<ul>
<li><code class="language-text">migrateCreateDataStore</code></li>
<li><code class="language-text">migrateUpdateDataStore</code></li>
<li><code class="language-text">migrateDeleteDataStore</code></li>
</ul>
<p>Meanwhile, the migration signature turns from what it is now (<code class="language-text">(dataStore: BikeshedDataStore) =&gt; Promise&lt;void&gt;</code>) into <code class="language-text">(migrationInterface: BikeshedMigrationInterface) =&gt; Promise&lt;BikeshedMigration[]&gt;</code>, with <code class="language-text">BikeshedMigration</code> being one of the actions above.</p>
<p><code class="language-text">BikeshedMigrationInterface</code> would be the API that actually creates the above actions. This is essentially for namespacing, and just to separate concerns more. Furthermore, it is how you would actually retrieve the data. This is separate from the data store object, as not only does this completely stop mutability without needing the data store to be read only, but also it creates better types. More on that later.</p>
<p>What's more important, <strong>the validators are given to the actions themselves.</strong> This ensures that the data for that migration is always correct, assuming you create a new validator. While this could simply be <code class="language-text">assert</code>ed by the programmer before creating the actions, I feel that forcing a validator to be passed is much safer.</p>
<p>Looking back at <code class="language-text">namesToIds</code>, this might become:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token comment">-- Looks like saving names was a stupid idea...</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">namesToIds</span><span class="token punctuation">(</span>migrator<span class="token punctuation">)</span>
    <span class="token comment">-- The `get` the migrator contains takes *names*, not structs.</span>
    <span class="token comment">-- This is to further ensure migrations are correct no matter what your</span>
    <span class="token comment">-- surrounding code becomes, but also for better strict typing.</span>
    <span class="token comment">-- Again, more on that later.</span>
    <span class="token keyword">return</span> migrator
        <span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"Inventory"</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span><span class="token function">andThen</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">local</span> newInventory <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token keyword">for</span> _<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span> <span class="token keyword">do</span>
                table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>newInventory<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    Id <span class="token operator">=</span> Items<span class="token punctuation">.</span><span class="token function">getIdByName</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">end</span>

            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                migrator<span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">updateDataStore</span><span class="token punctuation">(</span>
                    <span class="token string">"Inventory"</span><span class="token punctuation">,</span>
                    newInventory<span class="token punctuation">,</span>
                    <span class="token comment">-- Because this is not a direct reference to any struct</span>
                    <span class="token comment">-- it will always be correct, even as the data changes.</span>
                    t<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">strictInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        Id <span class="token operator">=</span> t<span class="token punctuation">.</span>number<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span></code></pre></div>
<p>Something that creates data stores (for replacement) might become:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">itemsToInventory</span><span class="token punctuation">(</span>migrator<span class="token punctuation">)</span>
    <span class="token keyword">return</span> migrator
        <span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"Items"</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span><span class="token function">andThen</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                migrators<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">createDataStore</span><span class="token punctuation">(</span>
                    <span class="token string">"Inventory"</span><span class="token punctuation">,</span>
                    items<span class="token punctuation">,</span>
                    t<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">strictInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        Id <span class="token operator">=</span> t<span class="token punctuation">.</span>number<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>

                migrations<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">deleteDataStore</span><span class="token punctuation">(</span><span class="token string">"Items"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span></code></pre></div>
<h2>Strict Typing</h2>
<p>I would kill to use TypeScript and roblox-ts. They're stable enough to be used in production, as proven by Zombie Strike, and they <em>really work</em>. Even if Typed Lua had the syntax I need (such as generic function arguments, which are purportedly coming soon), it doesn't have the external tooling support required for it to fit into my workflow. The only reason I am not using roblox-ts for my next project is that I am the maintainer of <a href="https://github.com/Kampfkarren/selene">Selene</a>, a Lua linter. My projects move with me, and so if I don't use these tools myself, then they won't progress.</p>
<p>However, this data store library is going to be written in TypeScript (of course with easy inclusion into Lua projects). Data storage is simply too important and too volatile to consider Lua.</p>
<p>This means I have to make sure my types are good. Currently, the types are looking something like:</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> withBikeshed<span class="token operator">:</span> <span class="token punctuation">(</span>callback<span class="token operator">:</span> <span class="token punctuation">(</span>bikeshed<span class="token operator">:</span> Bikeshed<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">Bikeshed</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span><span class="token punctuation">(</span>player<span class="token operator">:</span> Player<span class="token punctuation">)</span><span class="token operator">:</span> BikeshedApi<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">BikeshedApi</span> <span class="token punctuation">{</span>
    <span class="token generic-function"><span class="token function">getStore</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>store<span class="token operator">:</span> BikeshedDataStoreInformation<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">></span><span class="token punctuation">)</span>
        <span class="token operator">:</span> BikeshedDataStore<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">BikeshedDataStore<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span>oldData<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">BikeshedDataStoreInformation<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> TSerialized<span class="token operator">></span></span> <span class="token punctuation">{</span>
    key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
    <span class="token function-variable function">serialize</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=></span> TSerialized<span class="token punctuation">;</span>
    <span class="token function-variable function">deserialize</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> TSerialized<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">T</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Quick tangent--I am unsure if this is the best way to do this. Rust has the ability to do something like:</p>
<div class="gatsby-highlight" data-language="rust"><pre class="language-rust"><code class="language-rust"><span class="token keyword">trait</span> <span class="token class-name">BikeshedDataStoreInformation</span> <span class="token punctuation">{</span>
    <span class="token comment">// vvv This is the part I want!</span>
    <span class="token keyword">type</span> <span class="token class-name">Data</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Serialized</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">fn</span> <span class="token function-definition function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Data</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">serialize</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Data</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Serialized</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Serialized</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Data</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>However, as far as I know, TypeScript has no way of doing this, so you'll just have to do something like retrieving the types from <code class="language-text">const InventoryStore: BikeshedDataStoreInformation&lt;Item[], number[]&gt;</code>, but then also need to support for data stores that don't have serializers...maybe <code class="language-text">never</code>? I don't know. Tangent over.</p>
<p>Anyway, the old migrations had a problem where your migrations wouldn't be able to even compile without using tricks like <code class="language-text">unknown</code>. Consider the old data implementation, but in TS.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">type</span> <span class="token class-name">OldItem</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    Name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">namesToIds</span><span class="token punctuation">(</span>dataStore<span class="token operator">:</span> BikeshedApi<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dataStore <span class="token operator">=</span> dataStore<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">getStore</span><span class="token generic class-name"><span class="token operator">&lt;</span>OldItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>stores<span class="token punctuation">.</span>Inventory<span class="token punctuation">)</span>
    <span class="token keyword">return</span> dataStore<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> newInventory <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newInventory<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                Id<span class="token operator">:</span> Items<span class="token punctuation">.</span><span class="token function">getIdByName</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> newInventory
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The problem here is in our <code class="language-text">update</code> function. <code class="language-text">update</code> is defined as <code class="language-text">update(callback: (oldData: T) =&gt; T): Promise&lt;void&gt;</code>. Meaning, it takes T (in this case <code class="language-text">OldItem[]</code>) and expects T to come out. Instead, we are returning <code class="language-text">{ Id: number }[]</code>. This would be frustrating with TypeScript.</p>
<p>However, with my proposal, these types can now be separated better. Let's consider the remake.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">namesToIds</span><span class="token punctuation">(</span>migrator<span class="token operator">:</span> BikeshedMigratorInterface<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>BikeshedMigrationAction<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> inventory<span class="token operator">:</span> OldItem<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> migrator<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">"Inventory"</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> newInventory <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>inventory<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newInventory<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            Id<span class="token operator">:</span> Items<span class="token punctuation">.</span><span class="token function">getIdByName</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span>
        migrator<span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">updateDataStore</span><span class="token punctuation">(</span>
            <span class="token string">"Inventory"</span><span class="token punctuation">,</span>
            newInventory<span class="token punctuation">,</span>
            <span class="token comment">// This is now, ideally, unnecessary, but for the sake of example...</span>
            t<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">strictInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                Id<span class="token operator">:</span> t<span class="token punctuation">.</span><span class="token builtin">number</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The types of everything are now sound!</p>
<p><code class="language-text">migrator.get(key: string)</code> would just return <code class="language-text">T</code>, in this case, the inferred <code class="language-text">OldItem[]</code>. <code class="language-text">migrator.actions.updateDataStore</code>, a completely separate function, would accept its own arbitrary type, in this case the inferred <code class="language-text">{ Id: number }</code>. Wonderful!</p></span></div><hr/><a href="/">Back to blog</a><div><noscript>You need JavaScript to be able to comment.</noscript></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/articles/migrators-validators-and-strict-typing/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-c64b171993bb26b718fb.js"],"app":["/app-a6864048c0301abf14c6.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-1c3725810481f8d99e37.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-bfd3d98725a8c29a9009.js"],"component---src-templates-article-tsx":["/component---src-templates-article-tsx-446c53b14a781b62ca98.js"]};/*]]>*/</script><script src="/polyfill-c64b171993bb26b718fb.js" nomodule=""></script><script src="/component---src-templates-article-tsx-446c53b14a781b62ca98.js" async=""></script><script src="/commons-7eb882d59dd8e849a053.js" async=""></script><script src="/app-a6864048c0301abf14c6.js" async=""></script><script src="/framework-37869815b964c2e4180c.js" async=""></script><script src="/webpack-runtime-dfc7841f6f79d0d83b6e.js" async=""></script></body></html>