<!DOCTYPE html><html><head><style data-href="/styles.07f6c19cd418b997eaac.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:visible;padding:1px;position:relative}pre[class*=language-]>code{background-attachment:local;background-color:#fdfdfd;background-image:linear-gradient(transparent 50%,rgba(69,142,209,.04) 0);background-origin:content-box;background-size:3em 3em;border-left:10px solid #358ccb;box-shadow:-1px 0 0 0 #358ccb,0 0 0 1px #dfdfdf;position:relative;z-index:1}code[class*=language-]{display:block;height:inherit;max-height:inherit;overflow:auto;padding:0 1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdfdfd;box-sizing:border-box;margin-bottom:1em}:not(pre)>code[class*=language-]{border:1px solid rgba(0,0,0,.1);border-radius:.3em;color:#c92c2c;display:inline;padding:.2em;position:relative;white-space:normal}pre[class*=language-]:after,pre[class*=language-]:before{bottom:.75em;box-shadow:0 13px 8px #979797;content:"";display:block;height:20%;left:.18em;max-height:13em;position:absolute;transform:rotate(-2deg);width:40%}pre[class*=language-]:after{left:auto;right:.75em;transform:rotate(2deg)}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#7d8b99}.token.punctuation{color:#5f6364}.token.boolean,.token.constant,.token.deleted,.token.function-name,.token.number,.token.property,.token.symbol,.token.tag{color:#c92c2c}.token.attr-name,.token.builtin,.token.char,.token.function,.token.inserted,.token.selector,.token.string{color:#2f9c0a}.token.entity,.token.operator,.token.url,.token.variable{background:hsla(0,0%,100%,.5);color:#a67f59}.token.atrule,.token.attr-value,.token.class-name,.token.keyword{color:#1990b8}.token.important,.token.regex{color:#e90}.language-css .token.string,.style .token.string{background:hsla(0,0%,100%,.5);color:#a67f59}.token.important{font-weight:400}.token.bold{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.7}@media screen and (max-width:767px){pre[class*=language-]:after,pre[class*=language-]:before{bottom:14px;box-shadow:none}}pre[class*=language-].line-numbers.line-numbers{padding-left:0}pre[class*=language-].line-numbers.line-numbers code{padding-left:3.8em}pre[class*=language-].line-numbers.line-numbers .line-numbers-rows{left:0}pre[class*=language-][data-line]{padding-bottom:0;padding-left:0;padding-top:0}pre[data-line] code{padding-left:4em;position:relative}pre .line-highlight{margin-top:0}@font-face{font-family:M PLUS\ 1p;font-style:normal;font-weight:400;src:local(""),url(/fonts/m-plus-1p-v19-latin-regular.woff2) format("woff2"),url(/fonts/m-plus-1p-v19-latin-regular.woff) format("woff")}</style><meta name="generator" content="Gatsby 3.15.0"/><title data-react-helmet="true">Committing to Safety (in data stores) - boyned&#x27;s blog</title><meta data-react-helmet="true" charSet="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" property="og:title" content="Committing to Safety (in data stores) - boyned&#x27;s blog"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:url" content="https://blog.boyned.com/articles/committing-to-safety-in-data-stores/"/><meta data-react-helmet="true" property="og:image" content="https://blog.boyned.com/emblem.png"/><meta data-react-helmet="true" property="og:description" content="I have decided on a test game for my new data store library. I want to create a very basic video editor and theatre. You make very simple…"/><meta data-react-helmet="true" property="og:article:published_time" content="2022-05-05"/><meta data-react-helmet="true" property="og:article:author" content="boyned"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="Committing to Safety (in data stores) - boyned&#x27;s blog"/><meta data-react-helmet="true" name="twitter:description" content="I have decided on a test game for my new data store library. I want to create a very basic video editor and theatre. You make very simple…"/><meta data-react-helmet="true" name="twitter:image" content="https://blog.boyned.com/emblem.png"/><style data-styled="" data-styled-version="5.3.11">.hErZMZ{text-align:center;}/*!sc*/
data-styled.g1[id="header__StyledHeader-sc-ehg0ch-0"]{content:"hErZMZ,"}/*!sc*/
.iQLVhX{color:white;display:block;font-weight:bolder;font-size:2em;-webkit-text-decoration:none;text-decoration:none;-webkit-animation:cxWZgL 0.8s alternate infinite;animation:cxWZgL 0.8s alternate infinite;}/*!sc*/
data-styled.g2[id="header__TitleLink-sc-ehg0ch-1"]{content:"iQLVhX,"}/*!sc*/
.iGINZU{font-family:"M PLUS 1p";}/*!sc*/
data-styled.g3[id="layout__Main-sc-ccgz52-0"]{content:"iGINZU,"}/*!sc*/
body{background:repeating-linear-gradient(13deg,hsl(31,96%,85%) 0 50px,hsl(31,96%,90%) 50px 100px);background-size:100px 100px;}/*!sc*/
data-styled.g4[id="sc-global-gNCfBn1"]{content:"sc-global-gNCfBn1,"}/*!sc*/
.eIMmoQ{background-color:#eee;background-image:radial-gradient(#ddd 22%,transparent 11%);background-position:0 0,50px 50px;background-size:10px 10px;margin:auto;margin-top:1em;padding:1% 3%;max-width:850px;width:calc(100% - 20px);}/*!sc*/
.eIMmoQ blockquote{background:white;padding:8px;margin:8px;border-left:4px solid #77f;}/*!sc*/
data-styled.g5[id="layout__Content-sc-ccgz52-1"]{content:"eIMmoQ,"}/*!sc*/
.bEOJGi .custom-block.info{background:hsla(217,90%,60%,50%);border:5px solid hsla(217,90%,60%,50%);border-radius:10px;padding:0.5% 1.5%;}/*!sc*/
.bEOJGi .custom-block.info .custom-block-heading{font-weight:bold;font-size:1.5em;text-align:center;}/*!sc*/
data-styled.g9[id="article__BlogContent-sc-1uy6qa4-0"]{content:"bEOJGi,"}/*!sc*/
@-webkit-keyframes cxWZgL{0%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}25%{text-shadow:0 -0.05em 0.2em #FFF,0 -0.05em 0.17em #FE0,0.04em -0.12em 0.22em #FC0,0.04em -0.13em 0.27em #F90,0.05em -0.23em 0.33em #F70,0.07em -0.28em 0.47em #F70,0.1em -0.3em 0.8em #F50,0.1em -0.3em 0.9em #F40;}50%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}75%{text-shadow:0 -0.05em 0.2em #FFF,0 -0.06em 0.18em #FE0,0.05em -0.15em 0.23em #FC0,0.05em -0.15em 0.3em #F90,0.07em -0.25em 0.4em #F70,0.09em -0.3em 0.5em #F70,0.1em -0.3em 0.9em #F50,0.1em -0.3em 1.0em #F40;}100%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}}/*!sc*/
@keyframes cxWZgL{0%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}25%{text-shadow:0 -0.05em 0.2em #FFF,0 -0.05em 0.17em #FE0,0.04em -0.12em 0.22em #FC0,0.04em -0.13em 0.27em #F90,0.05em -0.23em 0.33em #F70,0.07em -0.28em 0.47em #F70,0.1em -0.3em 0.8em #F50,0.1em -0.3em 0.9em #F40;}50%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}75%{text-shadow:0 -0.05em 0.2em #FFF,0 -0.06em 0.18em #FE0,0.05em -0.15em 0.23em #FC0,0.05em -0.15em 0.3em #F90,0.07em -0.25em 0.4em #F70,0.09em -0.3em 0.5em #F70,0.1em -0.3em 0.9em #F50,0.1em -0.3em 1.0em #F40;}100%{text-shadow:0 -0.05em 0.2em #FFF,0.01em -0.02em 0.15em #FE0,0.01em -0.05em 0.15em #FC0,0.02em -0.15em 0.2em #F90,0.04em -0.20em 0.3em #F70,0.05em -0.25em 0.4em #F70,0.06em -0.2em 0.9em #F50,0.1em -0.1em 1.0em #F40;}}/*!sc*/
data-styled.g10[id="sc-keyframes-cxWZgL"]{content:"cxWZgL,"}/*!sc*/
.fDwuGh{color:white;-webkit-filter:drop-shadow(3px 3px 3px black);filter:drop-shadow(3px 3px 3px black);}/*!sc*/
data-styled.g11[id="header__StyledLinks-sc-ehg0ch-2"]{content:"fDwuGh,"}/*!sc*/
.byrTFw{color:white;-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g12[id="header__StyledLink-sc-ehg0ch-3"]{content:"byrTFw,"}/*!sc*/
</style><link as="script" rel="preload" href="/webpack-runtime-7ca45d91f4f94a14e5dd.js"/><link as="script" rel="preload" href="/framework-ff9e621889a3488e7ca7.js"/><link as="script" rel="preload" href="/app-abe0763382bc5a78732a.js"/><link as="script" rel="preload" href="/commons-c15664be3cb0c7e14a3e.js"/><link as="script" rel="preload" href="/component---src-templates-article-tsx-1a214460002f94985074.js"/><link as="fetch" rel="preload" href="/page-data/articles/committing-to-safety-in-data-stores/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2428300253.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout__Main-sc-ccgz52-0 iGINZU"><div class="header__StyledHeader-sc-ehg0ch-0 hErZMZ"><a class="header__TitleLink-sc-ehg0ch-1 iQLVhX" href="/">boyned&#x27;s blog</a><div class="header__StyledLinks-sc-ehg0ch-2 fDwuGh"><span><a href="https://twitter.com/Kampfkarren" class="header__StyledLink-sc-ehg0ch-3 byrTFw">Twitter</a> <!-- --> | </span><span><a href="https://github.com/Kampfkarren" class="header__StyledLink-sc-ehg0ch-3 byrTFw">GitHub</a> <!-- --> | </span><span><a href="https://ko-fi.com/boyned" class="header__StyledLink-sc-ehg0ch-3 byrTFw">Ko-fi</a> </span></div></div><div class="layout__Content-sc-ccgz52-1 eIMmoQ"><header style="border-bottom:2px solid rgba(50, 50, 50, 0.3)"><h1 style="margin-bottom:-4px">Committing to Safety (in data stores)</h1><p>12<!-- --> minute read</p></header><div class="article__BlogContent-sc-1uy6qa4-0 bEOJGi"><span><p>I have decided on a test game for my <a href="https://blog.boyned.com/articles/thoughts-and-regrets-on-datastore2/">new data store library</a>. I want to create a very basic video editor and theatre. You make very simple videos (think <a href="https://picard.ytmnd.com/">YTMND</a>, because that's even what it's codenamed). There's a big theatre that then plays those videos one at a time, and you can give them a like if you want. The fun is getting to sit back and watch a constant stream of the amalgamations of the minds of Roblox players. But without installing TikTok.</p>
<p>This would all work well and fine with DataStore2, but there's a catch! For you see, I want to see videos from people who aren't in the server, and who have never BEEN in the server. Even worse, <strong>I want to like videos from people who aren't in the server</strong>. Cross server writing! Global data stores! No player! Eep!</p>
<p>Oh, and the library is called uright now. Because u write. And I'm going to get it right this time.</p>
<h2>Wait, what's the problem?</h2>
<p>Setting a data store without a player? Isn't that just like...data stores? You know, to store data?? What's the problem? Player persistence was deprecated like a billion years ago!</p>
<p>The problem is caching. DataStore2, and now uright, pride themselves on being one-set one-get. You should never have to build your own caching system on top of either of these libraries.</p>
<p>When you call <code class="language-text">:get()</code>, one of two things will happen. If this is the first time we are attempting to get, then we perform the "initial get". This does a true call to <code class="language-text">:GetAsync()</code>, as well as performing deserialization and the like. It will then cache that value. From then on, every <code class="language-text">:get()</code> will not perform a second data store call. That's one-get.</p>
<p>One-set is the opposite end. "Setting" to a store just updates the cached value. The one-set happens when the player leaves, that is the only time <code class="language-text">:SetAsync</code> is called. You can manually call <code class="language-text">:save()</code> if you wish, like when the player purchases something with Robux, or on a recurring timer, but uright does not require it.</p>
<p>This makes working within Roblox's admittedly generous data store limits completely straight forward, with no surprises. uright will only save when it has to, or when you ask it to.</p>
<p>The caveat here is when two servers override the same data. Consider the following scenario.</p>
<p><strong>Server A</strong> has player Alice. When Alice is loading, our code grabs their currency and sends it to them. The initial get has been performed, and now every time Alice gets or spends money, it's the cached value that is updated.</p>
<p><strong>Server B</strong> does not have Alice, but has an admin with a panel to allow them to give money to other players. Alice has won a social media contest, and the admin is going in to give them their rewards. Server B performs its own initial get on Alice's data store, and rewards her the currency, saving to the data store afterwards.</p>
<p>Do you see it? <strong>We're causing a data race!</strong> One of these servers is going to get overriden.</p>
<p>That's because Server A has no idea the data was updated at all. It has its cached value, it isn't communicating with the data store at all anymore. When Alice leaves the game, Server A will save her <strong>cached data</strong>, and completely override the edits made in Server B.</p>
<p><strong>This is why DataStore2 has always avoided giving the ability to edit data stores of players not in game.</strong> It is not safe. uright will also block the ability to edit data stores of players for this reason, though does not object to read-only support.</p>
<p>One reason solving this is difficult is <a href="https://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a>.</p>
<p>While the P (partition tolerance) might be a confusing allegory for Roblox, the core of it is that in a networked system like data stores, you can only either be <strong>consistent</strong>, meaning every time you get data, it is guaranteed to be correct, or <strong>available</strong>, meaning you have <em>some</em> data to get every time.</p>
<p>Roblox data stores choose consistency. <code class="language-text">:GetAsync()</code>, <code class="language-text">:SetAsync()</code>, etc all yield until the true current value is retrieved. If the correct data cannot be retrieved, they will error.</p>
<div class="custom-block info"><div class="custom-block-body"><p>This isn't <em>totally</em> true, <a href="https://devforum.roblox.com/t/details-on-datastoreservice-for-advanced-developers/175804#heading--cac">there's actually some form of cache</a>, but it's an undocumented implementation detail, and can certainly not be relied upon in the same way a one-get one-set library like uright can, and will appear inconsistent if you don't know its specific rules.</p></div></div>
<p>One-get one-set libraries, on the other hand, choose availability. The moment initial get completes, <code class="language-text">:get()</code> will always give you a value. Immediately, too! But you can't have both.</p>
<p>Global data stores make solving this problem necessary. While I'm okay with not supporting multi-server player store reads, I still need the ability to support non-player specific data stores for my videos idea. DataStore2 never had the ability to support non-player specific data.</p>
<h2>What are we working with?</h2>
<p>Ignoring the actual, well, video part, what would we assume a video to look like in a data store?</p>
<p>I think this is pretty reasonable:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
    authorId<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
    likes<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This lets us separate videos from player stores. Our global data store to support this will have the name "videos", with the keys being the video ID. So something like:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua">videos<span class="token punctuation">:</span>
    <span class="token punctuation">[</span><span class="token string">"dQw4w9WgXcQ"</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        title<span class="token punctuation">:</span> <span class="token string">"Rick Astley - Never Gonna Give You Up (Official Music Video)"</span><span class="token punctuation">,</span>
        authorId<span class="token punctuation">:</span> <span class="token number">3514424760</span><span class="token punctuation">,</span>
        likes<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token string">"QH2-TGUlwu4"</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token punctuation">...</span>etc etc<span class="token punctuation">...</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">...</span></code></pre></div>
<p>In uright, you must declare your data stores up front, so let's do that.</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token comment">-- In stores/videos.lua</span>
<span class="token keyword">local</span> videos

<span class="token comment">-- This normally refers to the field inside a player's store.</span>
<span class="token comment">-- All of a player's data is saved as one big dictionary so</span>
<span class="token comment">-- we can get it all immediately (and to truly perform only one get).</span>
<span class="token comment">-- Global data stores aren't combined, so this will instead refer to</span>
<span class="token comment">-- the name of the global data store.</span>
videos<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">"videos"</span>

videos<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token keyword">nil</span>

videos<span class="token punctuation">.</span>validate <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">strictInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> t<span class="token punctuation">.</span>string<span class="token punctuation">,</span>
    authorId<span class="token punctuation">:</span> t<span class="token punctuation">.</span>integer<span class="token punctuation">,</span>
    likes<span class="token punctuation">:</span> t<span class="token punctuation">.</span>integer<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">return</span> videos</code></pre></div>
<p>Normally, creating a uright store requires a player...</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token keyword">local</span> playerStore <span class="token operator">=</span> uright<span class="token punctuation">:</span><span class="token function">fromPlayer</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span>
<span class="token keyword">local</span> moneyStore <span class="token operator">=</span> playerStore<span class="token punctuation">:</span><span class="token function">getStore</span><span class="token punctuation">(</span>MoneyStore<span class="token punctuation">)</span>
moneyStore<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">andThen</span><span class="token punctuation">(</span>print<span class="token punctuation">)</span> <span class="token comment">-- Will print how much money the player has</span></code></pre></div>
<p>...but we don't have one to associate with, so let's just invent a new API.</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token keyword">local</span> videosStore <span class="token operator">=</span> uright<span class="token punctuation">:</span><span class="token function">getGlobalStore</span><span class="token punctuation">(</span>VideosStore<span class="token punctuation">)</span>

<span class="token comment">-- We have to specify the key now, unlike :get(),</span>
<span class="token comment">-- they're a different interface after all.</span>
<span class="token keyword">local</span> videoStore <span class="token operator">=</span> videosStore<span class="token punctuation">:</span><span class="token function">open</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span>

videoStore<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">andThen</span><span class="token punctuation">(</span>print<span class="token punctuation">)</span></code></pre></div>
<p>Alright, now to give people the ability to like videos.</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua">LikeVideo<span class="token punctuation">.</span>OnServerEvent<span class="token punctuation">:</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>player<span class="token punctuation">,</span> videoId<span class="token punctuation">)</span>
    <span class="token comment">-- Bla bla bla validate the remote etc etc</span>
    <span class="token function">likeVideo</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span></code></pre></div>
<p>Then I'll start writing the implementation...</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">likeVideo</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span>
    <span class="token comment">-- Hmm...</span>
<span class="token keyword">end</span></code></pre></div>
<p>Oh right. The, the entire first part of the article, yeah. Okay, what are our options?</p>
<h3>1. A basic set?</h3>
<p>Ah, what the hell. The simplest solution is always the best, after all.</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">likeVideo</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span>
    <span class="token keyword">local</span> videoStore <span class="token operator">=</span> videosStore<span class="token punctuation">:</span><span class="token function">open</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span>
    <span class="token keyword">return</span> videoStore<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">andThen</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span>
        <span class="token comment">-- Everything in uright must be treated immutably.</span>
        <span class="token keyword">local</span> newVideo <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span>
        newVideo<span class="token punctuation">.</span>likes <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span>
        videoStore<span class="token punctuation">:</span><span class="token function">set</span><span class="token punctuation">(</span>newVideo<span class="token punctuation">)</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span></code></pre></div>
<p>Nice and simple...oh wait. The real world is about to show up.</p>
<p><strong>Server A</strong> starts to play video <code class="language-text">dQw4w9WgXcQ</code>. We perform initial get, and capture the following data:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">"Rick Astley - Never Gonna Give You Up (Official Music Video)"</span><span class="token punctuation">,</span>
    authorId<span class="token punctuation">:</span> <span class="token number">3514424760</span><span class="token punctuation">,</span>
    likes<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p>In server A, 5 people give it a like. Our code will update our cached value appropriately:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">"Rick Astley - Never Gonna Give You Up (Official Music Video)"</span><span class="token punctuation">,</span>
    authorId<span class="token punctuation">:</span> <span class="token number">3514424760</span><span class="token punctuation">,</span>
    likes<span class="token punctuation">:</span> <span class="token number">1005</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p>But this is only a cache! The actual data has not been saved yet.</p>
<p>While this is going on, <strong>Server B</strong> also gets the video <code class="language-text">dQw4w9WgXcQ</code>, but for a different reason! The player who made it wants to change the title of the video. So that server sets the data store (saved, not just cache) to:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">"Rick Rolled!!!"</span><span class="token punctuation">,</span>
    authorId<span class="token punctuation">:</span> <span class="token number">3514424760</span><span class="token punctuation">,</span>
    likes<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Server A still has the old title! When Server A saves its own data, <strong>it's going to overwrite the title change!</strong></p>
<p>And in case it couldn't get any worse, now <strong>Server C</strong> shows up and ALSO plays the video! 3 people give it a like in that server, with Server C now having the following data in its cache:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">"Rick Rolled!!!"</span><span class="token punctuation">,</span>
    authorId<span class="token punctuation">:</span> <span class="token number">3514424760</span><span class="token punctuation">,</span>
    likes<span class="token punctuation">:</span> <span class="token number">1003</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p>It's all going horribly wrong!!!</p>
<h3>2. UpdateAsync to the rescue?</h3>
<p>Roblox data stores provide the <a href="https://developer.roblox.com/en-us/api-reference/function/GlobalDataStore/UpdateAsync">UpdateAsync API</a>. This gives you the ability to perform a set/get at the same time:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua">dataStore<span class="token punctuation">:</span><span class="token function">UpdateAsync</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">createNewValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span></code></pre></div>
<p>This is the only form of atomicity in Roblox, so savor it.</p>
<p>We can't just use this every set, of course, we are a one-set API, sets should perform instantly.</p>
<p>However, we can definitely keep in mind that, by the time we <em>are</em> saving, we have access to the most up to date value in the data store.</p>
<p>What if we attached the behavior for UpdateAsync to our data store itself?</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token comment">-- In stores/videos.lua</span>
<span class="token keyword">local</span> videos

videos<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">"videos"</span>

videos<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token keyword">nil</span>

videos<span class="token punctuation">.</span>validate <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">strictInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> t<span class="token punctuation">.</span>string<span class="token punctuation">,</span>
    authorId<span class="token punctuation">:</span> t<span class="token punctuation">.</span>integer<span class="token punctuation">,</span>
    likes<span class="token punctuation">:</span> t<span class="token punctuation">.</span>integer<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">-- New!</span>
<span class="token keyword">function</span> videos<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>currentDataStoreValue<span class="token punctuation">,</span> cachedValue<span class="token punctuation">,</span> valueDuringInitialGet<span class="token punctuation">)</span>
    <span class="token comment">-- Clone the CURRENT DATA STORE VALUE, which is provided by UpdateAsync.</span>
    <span class="token comment">-- This is so we don't override changes we don't think we care about.</span>
    <span class="token keyword">local</span> newValue <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span>currentDataStoreValue<span class="token punctuation">)</span>

    <span class="token comment">-- Update with the new amount of likes, understanding it is an increment</span>
    newValue<span class="token punctuation">.</span>likes <span class="token operator">+</span><span class="token operator">=</span> cachedValue<span class="token punctuation">.</span>likes <span class="token operator">-</span> valueDuringInitialGet<span class="token punctuation">.</span>likes

    <span class="token comment">-- Some other logic to update the new value if our cached value</span>
    <span class="token comment">-- was changed.</span>

    <span class="token keyword">return</span> newValue
<span class="token keyword">end</span>

<span class="token keyword">return</span> videos</code></pre></div>
<p>Our previous example would now change. Server A, when it's going to save its data, would just add on the new likes. Server B will change the title, but in our pseudo-code, it won't change the likes. Server C does the same as server A, just adds the likes.</p>
<p>This is the only place we care about concurrency, everything else would just transparently call <code class="language-text">:set</code>.</p>
<p>There's no gotchas here, at least that I can see, this would work fundamentally.</p>
<p>The big problem is making sure your result is correct. I can see it being very finnicky, and one wrong move will lead to some value being lost when it shouldn't have been, and you wouldn't even know it in Studio. Plus, I haven't specced this out for every reasonable use case. It already feels clunky to me that I needed to add a parameter for data during initial get, just because I couldn't figure out a nicer way to make sure likes were tracked!</p>
<p>It's a footgun--it's really easy to just take the easy route and say <code class="language-text">return cachedValue</code>, and ruin everything. It should be easy to do the right thing, and when you do the wrong thing, it should have a good chance of blowing up and telling you what to do differently.</p>
<h3>3. Commits</h3>
<p>This is the one I like. What if, instead of directly <code class="language-text">:set</code>'ing over the data store, and having one place where we UpdateAsync, we just pretend we're always in UpdateAsync?</p>
<p>Think Rodux. In Rodux, you don't set the entire state. You call actions, which perform smaller pieces of work.</p>
<p>Let's see how that would look:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">likeVideo</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span>
    <span class="token keyword">local</span> videoStore <span class="token operator">=</span> videosStore<span class="token punctuation">:</span><span class="token function">open</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span>
    <span class="token keyword">return</span> videoStore<span class="token punctuation">:</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span>
        <span class="token keyword">local</span> newVideo <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span>
        newVideo<span class="token punctuation">.</span>likes <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">return</span> newVideo
    <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span></code></pre></div>
<p>This may just look like the equivalent to <code class="language-text">:Update</code> in DataStore2, but it's different in what you're <em>allowed to do with it</em>.</p>
<p>That's because the commits serve two purposes.</p>
<ol>
<li>They update the cache directly.</li>
</ol>
<p>This is equivalent to <code class="language-text">:Update</code>. The <code class="language-text">video</code> we are being passed is the cached value. That's expected.</p>
<ol start="2">
<li>It is called A SECOND TIME during UpdateAsync.</li>
</ol>
<p>So, unlike <code class="language-text">:Update</code>, this commit is the key to concurrency.</p>
<p>When we end up saving the video store, any commits that were run, but not saved, will be re-executed with the current data store value.</p>
<p>In practice, this means we don't even have to worry about making sure titles are preserved. Our <code class="language-text">likeVideo</code> function only concerns itself with likes. Our multi-server example is still solved!</p>
<p>However, this has its own host of issues.</p>
<h2>The delicate dance of commits</h2>
<p>If you thought <code class="language-text">update</code> on stores had footgun problems, wait until you think for a few extra seconds about commits.</p>
<p>The ultimate fact that must be upheld is that a commit <strong>must be pure and deterministic</strong>, and <strong>must not rely on any external state</strong>. It <em>will</em> run twice, with <em>potentially different</em> pieces of data.</p>
<p>Consider the following code incorrect usage of <code class="language-text">commit</code>:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token keyword">local</span> videoStore <span class="token operator">=</span> videosStore<span class="token punctuation">:</span><span class="token function">open</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span>

videoStore<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">andThen</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span>
    videoStore<span class="token punctuation">:</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> newVideo <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span>
        newVideo<span class="token punctuation">.</span>likes <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">return</span> newVideo
    <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span></code></pre></div>
<p>All of this code will do the wrong thing, invisibly. This is exactly the same as our naive set implementation. We're not using the current value in the data store! We're relying on the external data point of "value".</p>
<p>The hard thing is, we can't really detect this either! Even making a theoretical <a href="https://github.com/Kampfkarren/selene">selene lint</a> borders on impossible in my head, since you likely still want to be able to use, say, libraries, which count as upvalues. The closest thing is requiring you use the argument passed to <code class="language-text">commit</code> somehow, but this is far from the only way to mess up.</p>
<p>Or even consider this:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token keyword">local</span> videoStore <span class="token operator">=</span> videosStore<span class="token punctuation">:</span><span class="token function">open</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span>

videoStore<span class="token punctuation">:</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span>
    <span class="token keyword">local</span> newVideo <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span>
    newVideo<span class="token punctuation">.</span>likes <span class="token operator">=</span> newLikeCount
    <span class="token keyword">return</span> newVideo
<span class="token keyword">end</span><span class="token punctuation">)</span></code></pre></div>
<p>The same exact problem, in a form that would be valid if this was a non-incremental value (such as the video's title), also with the hidden bug!</p>
<p>There <em>is</em> however, a separate class of bug we <em>can</em> detect, to a degree.</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua">videoStore<span class="token punctuation">:</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span>
    <span class="token keyword">local</span> newVideo <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span>

    <span class="token keyword">local</span> coAuthors <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">-- Everyone helped!</span>
    <span class="token keyword">for</span> _<span class="token punctuation">,</span> player <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>Players<span class="token punctuation">:</span><span class="token function">GetPlayers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
        table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>coAuthors<span class="token punctuation">,</span> player<span class="token punctuation">.</span>UserId<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    newVideo<span class="token punctuation">.</span>coAuthors <span class="token operator">=</span> coAuthors

    <span class="token keyword">return</span> newVideo
<span class="token keyword">end</span><span class="token punctuation">)</span></code></pre></div>
<p>This is a problem of determinism. <code class="language-text">Players:GetPlayers()</code> could return different players depending on whether or not it is called immediately, or before saving.</p>
<p>This can be detected, in more than zero circumstances, in development.</p>
<p>We can perform a trick here, specifically in Studio, where we are not writing to a real data store anyway.</p>
<p>In this example, when this commit is made, and we are the only player in the server, this will set the cached value to:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token punctuation">{</span>
    <span class="token comment">-- title, likes, etc</span>
    coAuthors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>...but when we pretend to save, our buggy commit implementation will instead look like:</p>
<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token punctuation">{</span>
    <span class="token comment">-- title, likes, etc</span>
    coAuthors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>...since there are no players.</p>
<p>With deterministic, pure commits, and without any other server to change the data (remember, we are not performing a real UpdateAsync call in Studio), these two values should never be different! I think we could potentially <strong>check deep equality</strong> on the cached value and the value that would've been saved, if it were real, the one with all the commits applied.</p>
<div class="custom-block info"><div class="custom-block-heading">What did we learn?</div><div class="custom-block-body"><ol>
<li>Multi-server data store writing is hard.</li>
<li>The solutions to it have some nasty footguns.</li>
<li>In the end, :UpdateAsync() is your friend.</li>
</ol></div></div></span></div><hr/><a href="/">Back to blog</a><div><noscript>You need JavaScript to be able to comment.</noscript></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/articles/committing-to-safety-in-data-stores/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-abe0763382bc5a78732a.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-40a66b091cbbbf4c3063.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-35ac18644e1297563faf.js"],"component---src-templates-article-tsx":["/component---src-templates-article-tsx-1a214460002f94985074.js"]};/*]]>*/</script><script src="/component---src-templates-article-tsx-1a214460002f94985074.js" async=""></script><script src="/commons-c15664be3cb0c7e14a3e.js" async=""></script><script src="/app-abe0763382bc5a78732a.js" async=""></script><script src="/framework-ff9e621889a3488e7ca7.js" async=""></script><script src="/webpack-runtime-7ca45d91f4f94a14e5dd.js" async=""></script></body></html>